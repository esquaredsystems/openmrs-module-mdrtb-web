{% extends 'app/reporting/report_base.html' %}

{% block content %}


<div>
    <div id="dq">
        <table class="resultsTable">
            <tr>
                <th class=normal colspan="4">{{"mdrtb.dq.title"|get_message:request.session.locale}}</th>
            </tr>
            <tr>
                <td colspan="2">{{"mdrtb.oblast"|get_message:request.session.locale}}</td>
                    {% if location.region %}
                <td colspan="2">{{ location.region.name }}</td>
                {% else %}
                <td colspan="2"></td>
                {% endif %}
            </tr>
            <tr>
                <td colspan="2">{{"mdrtb.district"|get_message:request.session.locale}}</td>
                    {% if location.district %}
                <td colspan="2">{{ location.district.name }}</td>
                {% else %}
                <td colspan="2"></td>
                {% endif %}
            </tr>
            <tr>
                <td colspan="2">{{"mdrtb.facility"|get_message:request.session.locale}}</td>
                    {% if location.facility %}
                <td colspan="2">{{ location.facility.name }}</td>
                {% else %}
                <td colspan="2"></td>
                {% endif %}
            </tr>
            <tr>
                <td colspan="2">{{"mdrtb.year"|get_message:request.session.locale}}</td>
                <td colspan="2" align="center">{{ request.GET.year }}</td>
            </tr>
            <tr>
                <td colspan="2">{{"mdrtb.quarter"|get_message:request.session.locale}}</td>
                <td align="center" colspan="2">{{ request.GET.quarter }}</td>
            </tr>
            <tr>
                <td colspan="2">{{"mdrtb.month"|get_message:request.session.locale}}</td>
                <td align="center" colspan="2">{{ request.GET.month }}</td>
            </tr>
            <tr>
                <td colspan="2">{{"mdrtb.dq.numberOfPatients"|get_message:request.session.locale}}</td>
                <td align="center" colspan="2">{{ results.num }}</td>
            </tr>
            <tr>
                <td colspan="2">{{"mdrtb.dq.numberWithErrors"|get_message:request.session.locale}}</td>
                <td align="center" colspan="2">{{ results.errorCount }}</td>
            </tr>
            <tr>
                <td colspan="2">{{"mdrtb.dq.errorPercentage"|get_message:request.session.locale}}</td>
                <td align="center" colspan="2">{{ results.errorPercentage }}</td>
            </tr>
            <tr>
                <td colspan="4">&nbsp;</td>
            </tr>
            <tr>
                <td colspan="4">&nbsp;</td>
            </tr>


            <tr>
                <th class=normal colspan="4">{{"mdrtb.dq.duplicateForm89"|get_message:request.session.locale}}</th>
            </tr>
            <tr>
                <td>{{"mdrtb.dq.fullName"|get_message:request.session.locale}}</td>
                <td>{{"mdrtb.dq.dob"|get_message:request.session.locale}}</td>
                <td align="center">{{"mdrtb.dq.gender"|get_message:request.session.locale}}</td>
                <td align="center">{{"mdrtb.dq.links"|get_message:request.session.locale}}</td>
            </tr>
            {% for row in results.duplicateForm89 %}
            <tr>

                <td><a href="{% url 'enrolledprograms' uuid=row.patientUuid %}" target="_blank">{{row.patientName}}</a>
                </td>
                <td>{{ row.dateOfBirth | string_to_date }}</td>
                <td align="center">{{ row.gender }}</td>
                <td>
                    {% for link in row.form89Links %}
                    <a href="{% url 'enrolledprograms' uuid=row.patientUuid %}"
                        target="_blank">{{"mdrtb.form89"|get_message:request.session.locale}} </a>&nbsp;
                    {% endfor %}
                </td>
            </tr>
            {% endfor %}

            <tr>
                <td colspan="4">&nbsp;</td>
            </tr>
            <tr>
                <td colspan="4">&nbsp;</td>
            </tr>

            <tr>
                <th class=normal colspan="4">{{"mdrtb.dq.duplicateTB03"|get_message:request.session.locale}}</th>
            </tr>
            <tr>
                <td>{{"mdrtb.dq.fullName"|get_message:request.session.locale}}</td>
                <td>{{"mdrtb.dq.dob"|get_message:request.session.locale}}</td>
                <td align="center">{{"mdrtb.dq.gender"|get_message:request.session.locale}}</td>
                <td align="center">{{"mdrtb.dq.links"|get_message:request.session.locale}}</td>
            </tr>
            {% for row in results.duplicateTB03 %}
            <tr>

                <td><a href="{% url 'enrolledprograms' uuid=row.patientUuid %}" target="_blank">{{row.patientName}}</a>
                </td>
                <td>{{ row.dateOfBirth | string_to_date }}</td>
                <td align="center">{{ row.gender }}</td>
                <td>
                    {% for link in row.tb03Links %}
                    <a href="{{ pageContext.request.contextPath }}{{ link }}"
                        target="_blank">{{"mdrtb.tb03"|get_message:request.session.locale}} </a>&nbsp;
                    {% endfor %}
                </td>
            </tr>
            {% endfor %}

            <tr>
                <td colspan="4">&nbsp;</td>
            </tr>
            <tr>
                <td colspan="4">&nbsp;</td>
            </tr>

            <tr>
                <th class=normal colspan="4">{{"mdrtb.dq.missingForm89"|get_message:request.session.locale}}</th>
            </tr>
            <tr>
                <td colspan="2">{{"mdrtb.dq.fullName"|get_message:request.session.locale}}</td>
                <td>{{"mdrtb.dq.dob"|get_message:request.session.locale}}</td>
                <td align="center">{{"mdrtb.dq.gender"|get_message:request.session.locale}}</td>
            </tr>
            {% for row in results.missingForm89 %}
            <tr>

                <td colspan="2"><a href="{% url 'enrolledprograms' uuid=row.patientUuid %}"
                        target="_blank">{{row.patientName}}</td>
                <td>{{ row.dateOfBirth | string_to_date }}</td>
                <td align="center">{{ row.gender }}</td>
            </tr>
            {% endfor %}

            <tr>
                <td colspan="4">&nbsp;</td>
            </tr>
            <tr>
                <td colspan="4">&nbsp;</td>
            </tr>
            <tr>
                <th class=normal colspan="4">{{"mdrtb.dq.invalidForm89"|get_message:request.session.locale}}</th>
            </tr>
            <tr>
                <td colspan="2">{{"mdrtb.dq.fullName"|get_message:request.session.locale}}</td>
                <td>{{"mdrtb.dq.dob"|get_message:request.session.locale}}</td>
                <td align="center">{{"mdrtb.dq.gender"|get_message:request.session.locale}}</td>
            </tr>
            {% for row in results.invalidForm89 %}
            <tr>

                <td colspan="2"><a href="{% url 'enrolledprograms' uuid=row.patientUuid %}"
                        target="_blank">{{row.patientName}}</a></td>
                <td>{{ row.dateOfBirth | string_to_date }}</td>
                <td align="center">{{ row.gender }}</td>
            </tr>

            {% endfor %}

            <tr>
                <td colspan="4">&nbsp;</td>
            </tr>
            <tr>
                <td colspan="4">&nbsp;</td>
            </tr>
            <tr>
                <th class=normal colspan="4">{{"mdrtb.dq.missingAge"|get_message:request.session.locale}}</th>
            </tr>
            <tr>
                <td colspan="2">{{"mdrtb.dq.fullName"|get_message:request.session.locale}}</td>
                <td>{{"mdrtb.dq.dob"|get_message:request.session.locale}}</td>
                <td align="center">{{"mdrtb.dq.gender"|get_message:request.session.locale}}</td>
            </tr>
            {% for row in results.missingAge %}
            <tr>

                <td colspan="2"><a href="{% url 'enrolledprograms' uuid=row.patientUuid %}"
                        target="_blank">{{row.patientName}}</a></td>
                <td>{{ row.dateOfBirth | string_to_date }}</td>
                <td align="center">{{ row.gender }}</td>
            </tr>

            {% endfor %}
            <tr>
                <td colspan="4">&nbsp;</td>
            </tr>
            <tr>
                <td colspan="4">&nbsp;</td>
            </tr>
            <tr>
                <th class=normal colspan="4">{{"mdrtb.dq.missingPatientGroup"|get_message:request.session.locale}}</th>
            </tr>
            <tr>
                <td colspan="2">{{"mdrtb.dq.fullName"|get_message:request.session.locale}}</td>
                <td>{{"mdrtb.dq.dob"|get_message:request.session.locale}}</td>
                <td align="center">{{"mdrtb.dq.gender"|get_message:request.session.locale}}</td>
            </tr>
            {% for row in results.missingPatientGroup %}
            <tr>

                <td colspan="2"><a href="{% url 'enrolledprograms' uuid=row.patientUuid %}"
                        target="_blank">{{row.patientName}}</a></td>
                <td>{{ row.dateOfBirth | string_to_date }}</td>
                <td align="center">{{ row.gender }}</td>
            </tr>

            {% endfor %}
            <tr>
                <td colspan="4">&nbsp;</td>
            </tr>
            <tr>
                <td colspan="4">&nbsp;</td>
            </tr>
            <tr>
                <th class=normal colspan="4">{{"mdrtb.dq.missingDiagnosticTests"|get_message:request.session.locale}}
                </th>
            </tr>
            <tr>
                <td colspan="2">{{"mdrtb.dq.fullName"|get_message:request.session.locale}}</td>
                <td>{{"mdrtb.dq.dob"|get_message:request.session.locale}}</td>
                <td align="center">{{"mdrtb.dq.gender"|get_message:request.session.locale}}</td>
            </tr>
            {% for row in results.missingDiagnosticTests %}
            <tr>

                <td colspan="2"><a href="{% url 'enrolledprograms' uuid=row.patientUuid %}"
                        target="_blank">{{row.patientName}}</a>
                </td>
                <td>{{ row.dateOfBirth | string_to_date }}</td>
                <td align="center">{{ row.gender }}</td>
            </tr>

            {% endfor %}
            <tr>
                <td colspan="4">&nbsp;</td>
            </tr>
            <tr>
                <td colspan="4">&nbsp;</td>
            </tr>
            <tr>
                <th class=normal colspan="4">{{"mdrtb.dq.notStartedTreatment"|get_message:request.session.locale}}</th>
            </tr>
            <tr>
                <td colspan="2">{{"mdrtb.dq.fullName"|get_message:request.session.locale}}</td>
                <td>{{"mdrtb.dq.dob"|get_message:request.session.locale}}</td>
                <td align="center">{{"mdrtb.dq.gender"|get_message:request.session.locale}}</td>
            </tr>
            {% for row in results.notStartedTreatment %}
            <tr>

                <td colspan="2"><a href="{% url 'enrolledprograms' uuid=row.patientUuid %}"
                        target="_blank">{{row.patientName}}</a></td>
                <td>{{ row.dateOfBirth | string_to_date }}</td>
                <td align="center">{{ row.gender }}</td>
            </tr>

            {% endfor %}
            <tr>
                <td colspan="4">&nbsp;</td>
            </tr>
            <tr>
                <td colspan="4">&nbsp;</td>
            </tr>
            <tr>
                <th class=normal colspan="4">{{"mdrtb.dq.missingOutcomes"|get_message:request.session.locale}}</th>
            </tr>
            <tr>
                <td colspan="2">{{"mdrtb.dq.fullName"|get_message:request.session.locale}}</td>
                <td>{{"mdrtb.dq.dob"|get_message:request.session.locale}}</td>
                <td align="center">{{"mdrtb.dq.gender"|get_message:request.session.locale}}</td>
            </tr>
            {% for row in results.missingOutcomes %}
            <tr>

                <td colspan="2"><a href="{% url 'enrolledprograms' uuid=row.patientUuid %}"
                        target="_blank">{{row.patientName}}</a></td>
                <td>{{ row.dateOfBirth | string_to_date }}</td>
                <td align="center">{{ row.gender }}</td>
            </tr>

            {% endfor %}
            <tr>
                <td colspan="4">&nbsp;</td>
            </tr>
            <tr>
                <td colspan="4">&nbsp;</td>
            </tr>
            <tr>
                <th class=normal colspan="4">{{"mdrtb.dq.noDOTSId"|get_message:request.session.locale}}</th>
            </tr>
            <tr>
                <td colspan="2">{{"mdrtb.dq.fullName"|get_message:request.session.locale}}</td>
                <td>{{"mdrtb.dq.dob"|get_message:request.session.locale}}</td>
                <td align="center">{{"mdrtb.dq.gender"|get_message:request.session.locale}}</td>
            </tr>
            {% for row in results.noDOTSId %}
            <tr>

                <td colspan="2"><a href="{% url 'enrolledprograms' uuid=row.patientUuid %}"
                        target="_blank">{{row.patientName}}</a></td>
                <td>{{ row.dateOfBirth | string_to_date }}</td>
                <td align="center">{{ row.gender }}</td>
            </tr>

            {% endfor %}
            <tr>
                <td colspan="4">&nbsp;</td>
            </tr>
            <tr>
                <td colspan="4">&nbsp;</td>
            </tr>
            <tr>
                <th class=normal colspan="4">{{"mdrtb.dq.noSite"|get_message:request.session.locale}}</th>
            </tr>
            <tr>
                <td colspan="2">{{"mdrtb.dq.fullName"|get_message:request.session.locale}}</td>
                <td>{{"mdrtb.dq.dob"|get_message:request.session.locale}}</td>
                <td align="center">{{"mdrtb.dq.gender"|get_message:request.session.locale}}</td>
            </tr>
            {% for row in results.noSite %}
            <tr>

                <td colspan="2"><a href="{% url 'enrolledprograms' uuid=row.patientUuid %}"
                        target="_blank">{{row.patientName}}</a></td>
                <td>{{ row.dateOfBirth | string_to_date }}</td>
                <td align="center">{{ row.gender }}</td>
            </tr>
            {% endfor %}
            <tr>
                <td colspan="4">&nbsp;</td>
            </tr>
            <tr>
                <td colspan="4">&nbsp;</td>
            </tr>


            <tr>
                <th class=normal colspan="4">{{"mdrtb.dq.noTransferIn"|get_message:request.session.locale}}</th>
            </tr>
            <tr>
                <td>{{"mdrtb.dq.fullName"|get_message:request.session.locale}}</td>
                <td>{{"mdrtb.location"|get_message:request.session.locale}}</td>
                <td>{{"mdrtb.dq.dob"|get_message:request.session.locale}}</td>
                <td align="center">{{"mdrtb.dq.gender"|get_message:request.session.locale}}</td>
            </tr>
            {% for row in results.noTransferIn %}
            <tr>

                <td><a href="{% url 'enrolledprograms' uuid=row.patientUuid %}" target="_blank">{{row.patientName}}</a>
                </td>
                <td>{{ row.locName }}</td>
                <td>{{ row.dateOfBirth | string_to_date }}</td>
                <td align="center">{{ row.gender }}</td>
            </tr>
            {% endfor %}

            <tr>
                <td colspan="4">&nbsp;</td>
            </tr>
            <tr>
                <td colspan="4">&nbsp;</td>
            </tr>


            <tr>
                <th class=normal colspan="4">{{"mdrtb.dq.noTransferOut"|get_message:request.session.locale}}</th>
            </tr>
            <tr>
                <td>{{"mdrtb.dq.fullName"|get_message:request.session.locale}}</td>
                <td>{{"mdrtb.location"|get_message:request.session.locale}}</td>
                <td>{{"mdrtb.dq.dob"|get_message:request.session.locale}}</td>
                <td align="center">{{"mdrtb.dq.gender"|get_message:request.session.locale}}</td>
            </tr>
            {% for row in results.noTransferOut %}
            <tr>

                <td><a href="{% url 'enrolledprograms' uuid=row.patientUuid %}" target="_blank">{{row.patientName}}</a>
                </td>
                <td>{{ row.locName }}</td>
                <td>{{ row.dateOfBirth | string_to_date }}</td>
                <td align="center">{{ row.gender }}</td>
            </tr>
            {% endfor %}
        </table>

    </div>
    <input type="button" onclick="tableToExcel('f89', 'Form89')"
        value="{{'mdrtb.exportToExcelBtn'|get_message:request.session.locale}}" />

    <a href="/" type="button" id="back" name="back">{{'mdrtb.back'|get_message:request.session.locale}}</a>
    <input type="button" onclick="printForm()" value="{{'mdrtb.print'|get_message:request.session.locale}}" />
    <button onclick="saveHtml()">{{'mdrtb.save'|get_message:request.session.locale}}</button>
    <script type="text/javascript">
        function saveHtml() {
            let htmlContent = document.getElementById("f89").outerHTML;
            htmlContent = htmlContent.replace(/\s{2,}/g, ' ');
            let year = "{{request.GET.year}}"
            let location = "{{request.GET.location}}"
            let quarter = "{{request.GET.quarter}}" ? "{{request.GET.quarter}}" : null;
            let month = "{{request.GET.month}}" ? "{{request.GET.month}}" : null;

            data = {
                csrfmiddlewaretoken: "{{csrf_token}}",
                reportName: "Form-89",
                year,
                location,
                reportType: "DOTSTB",
                tableData: htmlContent
            }

            if (month != null) data.month = month
            if (quarter != null) data.quarter = quarter


            $.ajax({
                method: "POST",
                url: "/saveclosedreport",
                data: data,
                success: (data) => {
                    console.log(data)
                }
            })
        }

        function savePdf(action, reportName, formPath) {
            var tableData = (document.getElementById("f89")).innerHTML.toString();
            var oblast = "{{ oblast }}";
            var district = "{{ district }}";
            var facility = "{{ facility }}";
            var year = "{{ year }}";
            if (!"{{quarter}}") {
                var quarter = "\"" + "{{quarter}}" + "\"";
            } else {
                var quarter = "";
            }
            if (!"{{month}}") {
                var month = "\"" + "{{month}}" + "\"";
            } else {
                var month = "";
            }
            var reportDate = "{{ reportDate }}";

            var form = document.createElement("FORM");

            form.setAttribute("id", "closeReportForm");
            form.setAttribute("name", "closeReportForm");
            form.setAttribute("method", "post");
            form.setAttribute("action", action);

            document.body.appendChild(form);

            var input = document.createElement("INPUT");
            input.setAttribute("type", "hidden");
            input.setAttribute("id", "oblast");
            input.setAttribute("name", "oblast");
            input.setAttribute("value", oblast);
            form.appendChild(input);

            var input = document.createElement("INPUT");
            input.setAttribute("type", "hidden");
            input.setAttribute("id", "district");
            input.setAttribute("name", "district");
            input.setAttribute("value", district);
            form.appendChild(input);

            var input = document.createElement("INPUT");
            input.setAttribute("type", "hidden");
            input.setAttribute("id", "facility");
            input.setAttribute("name", "facility");
            input.setAttribute("value", facility);
            form.appendChild(input);

            var input = document.createElement("INPUT");
            input.setAttribute("type", "hidden");
            input.setAttribute("id", "year");
            input.setAttribute("name", "year");
            input.setAttribute("value", year);
            form.appendChild(input);

            var input = document.createElement("INPUT");
            input.setAttribute("type", "hidden");
            input.setAttribute("id", "quarter");
            input.setAttribute("name", "quarter");
            input.setAttribute("value", quarter);
            form.appendChild(input);

            var input = document.createElement("INPUT");
            input.setAttribute("type", "hidden");
            input.setAttribute("id", "month");
            input.setAttribute("name", "month");
            input.setAttribute("value", month);
            form.appendChild(input);

            var input = document.createElement("INPUT");
            input.setAttribute("type", "hidden");
            input.setAttribute("id", "reportDate");
            input.setAttribute("name", "reportDate");
            input.setAttribute("value", reportDate);
            form.appendChild(input);

            var input = document.createElement("INPUT");
            input.setAttribute("type", "hidden");
            input.setAttribute("id", "table");
            input.setAttribute("name", "table");
            input.setAttribute("value", tableData);
            form.appendChild(input);

            var input = document.createElement("INPUT");
            input.setAttribute("type", "hidden");
            input.setAttribute("id", "formPath");
            input.setAttribute("name", "formPath");
            input.setAttribute("value", formPath);
            form.appendChild(input);

            var input = document.createElement("INPUT");
            input.setAttribute("type", "hidden");
            input.setAttribute("id", "reportName");
            input.setAttribute("name", "reportName");
            input.setAttribute("value", reportName);
            form.appendChild(input);

            var input = document.createElement("INPUT");
            input.setAttribute("type", "hidden");
            input.setAttribute("id", "reportType");
            input.setAttribute("name", "reportType");
            input.setAttribute("value", "DOTSTB");
            form.appendChild(input);

            form.submit();
        }
        $(document).ready(function () {
            $("#tableToSql").bind("click", function () {
                if (confirm('{{"mdrtb.closeReportMessage"|get_message:request.session.locale}}')) {
                    savePdf("closeReport.form", "form89", "form89results");
                }
            });
            /* $("#tableToPdf").click(function(){
                savePdf("exportReport.form", "TB 03", "tb03Results");
            }); */
        });
    </script>
</div>

{% endblock %}