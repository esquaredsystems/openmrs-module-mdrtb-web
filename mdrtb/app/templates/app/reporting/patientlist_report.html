{% extends 'app/reporting/report_base.html' %}

{% block content %}


<div>
    <div style="font-size: 0.75rem;">

        <p class="text-xl"><b>Year:</b> {{year}}</p>
        <p class="text-xl"><b>Location:</b> {{location}}</p>
        {% if month %}
        <p><b>Month:</b> {{month}}</p>
        {% elif quarter %}
        <p><b>Quarter:</b> {{quarter}}</p>
        {% endif %}
        <p><b>List:</b> {{listname}}</p>
    </div>
    <div id="patientlist">{{ string_data|safe }}</div>
    <a class="no-underline" href="{% url 'patientlist' %}"><button>
            Back
        </button></a>
    <input type="button" onclick="tableToExcel('patientlist', 'Patient List')"
        value="{{'mdrtb.exportToExcelBtn'|get_message:request.session.locale}}" />
    <button onclick="print()">{{'mdrtb.print'|get_message:request.session.locale}}</button>
    <button onclick="saveHtml()">{{'mdrtb.save'|get_message:request.session.locale}}</button>
</div>
<script>
    var tableToExcel = (function () {
        var uri = 'data:application/vnd.ms-excel;base64,'
            , template = '<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>Patient List</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]--><meta http-equiv="content-type" content="text/plain; charset=UTF-8"/></head><body><table>{table}</table></body></html>'
            , base64 = function (s) { return window.btoa(unescape(encodeURIComponent(s))) }
            , format = function (s, c) { return s.replace(/{(\w+)}/g, function (m, p) { return c[p]; }) }
        return function (table, name) {
            if (!table.nodeType) table = document.getElementById(table)
            var ctx = { worksheet: name || 'Worksheet', table: table.innerHTML }
            window.location.href = uri + base64(format(template, ctx))
        }
    })()
    function saveHtml() {
        let htmlContent = document.getElementById("tb03").outerHTML;
        htmlContent = htmlContent.replace(/\s{2,}/g, ' ');
        let year = "{{request.GET.year}}"
        let location = "{{request.GET.location}}"
        let quarter = "{{request.GET.quarter}}" ? "{{request.GET.quarter}}" : null;
        let month = "{{request.GET.month}}" ? "{{request.GET.month}}" : null;

        data = {
            csrfmiddlewaretoken: "{{csrf_token}}",
            reportName: "TB-03",
            year,
            location,
            reportType: "DOTSTB",
            tableData: htmlContent
        }

        if (month != null) data.month = month
        if (quarter != null) data.quarter = quarter


        $.ajax({
            method: "POST",
            url: "/saveclosedreport",
            data: data,
            success: (data) => {
                console.log(data)
            }
        })


    }
</script>

{% endblock %}